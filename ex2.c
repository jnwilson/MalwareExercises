#include <stdio.h>
#include <Windows.h>
#include <wininet.h>
#pragma comment(lib, "wininet.lib")

int main(){
	int i = internetConnection();
	if (i){
		return 0;
	}
	else{
		int x = readFile();
		if(x){
			return 0;
		}
		else{
			printf("Success: Parsed command is %c", x);
			Sleep(60000);
		}
		return 0;
	}
	return 0;
}

int internetConnection(){
	int a = InternetGetConnectedState(0,0);
	if(a){
		printf("Success: Internet Connection\n");
		return 1;
	}
	else{
		printf("Error 1.1:No Internet\n");
		return 0;
	}
}

int readFile(){
	int *hInt = InternetOpen("Explorer 7.5/pma",INTERNET_OPEN_TYPE_PRECONFIG,NULL,NULL,INTERNET_FLAG_ASYNC);
	int *hFile = InternetOpenUrl(hInt,"http://www.practicalmalwareanalysis.com",NULL,0,INTERNET_FLAG_EXISTING_CONNECT,0);
	if(hFile){		
		printf("Error 2.1: Fail to OpenUrl");
		InternetCloseHandle(hInt);
		return 0;
		}
	else{
		DWORD NumberOfBytesRead;
		char Buffer[10] = "";
		int isRead = InternetReadFile(hFile,Buffer,512,&NumberOfBytesRead);
		if(isRead){
			printf("Error 2.2: Fail to ReadFile");
			InternetCloseHandle(hInt);
			InternetCloseHandle(hFile);
			return 0;
		}
		else{
			if(Buffer[0] == '<' && 
				Buffer[1] == '!' &&
				Buffer[2] == '-' &&
				Buffer[3] == '-'){
				char x = Buffer[4];
				return x;
			}
			else{
				printf("Error 2.3: Fail to get command");
				return 0;
			}
		}
	}
}
